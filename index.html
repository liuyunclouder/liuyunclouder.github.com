<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  




<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Ezio's Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Ezio's Blog">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ezio's Blog">
<meta name="twitter:description">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Author'
    }
  };
</script>

  <title> Ezio's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?a63d6742fa06ccda252c7c1bdc9649d9";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Ezio's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">record</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            About
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/17/使用Docker创建Elasticsearch服务/" itemprop="url">
                  使用Docker创建Elasticsearch服务
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-09-17T20:00:00+08:00" content="2016-09-17">
              2016-09-17
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/17/使用Docker创建Elasticsearch服务/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/17/使用Docker创建Elasticsearch服务/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近需要做的几个功能都是基于Elasticsearch，但又不想污染系统环境，所以就花了些时间研究下如何使用Docker创建Elastcisearch服务。</p>
<p>首先先分别了解下Docker和Elasticssearch。</p>
<h2 id="Docker是什么？"><a href="#Docker是什么？" class="headerlink" title="Docker是什么？"></a>Docker是什么？</h2><p>Docker是一个开源工具，能将一个WEB应用封装在一个轻量级，便携且独立的容器里，然后可以运行在几乎任何服务环境下。<br>Docker的容器能使应用跑在任何服务器上并且表现一致。一个开发者在笔记本上建立的一个容器，能跑在很多环境下，如：测试环境，生产环境，虚拟机上，VPS，OpenStack集群，公用的电脑等等<br>Docker的一般使用在以下几点：<br>•    自动化打包和部署应用<br>•    创造一个轻量级的，私人的 PAAS 环境<br>•    自动化测试和连续的 整合/部署<br>•    部署WEB应用，数据库和后端服务</p>
<p>所以，Docker是一个系统级兼容的容器，它采用Linux Container技术构建一个虚拟环境，用户可以在这个环境下安装各种应用来提供服务，并且这个环境可以随时创建或销毁，不会影响宿主环境</p>
<h2 id="Elasticsearch是什么？"><a href="#Elasticsearch是什么？" class="headerlink" title="Elasticsearch是什么？"></a>Elasticsearch是什么？</h2><p>Elasticsearch也使用Java开发并使用Lucene作为其核心来实现所有索引和搜索的功能，但是它的目的是通过简单的RESTful API来隐藏Lucene的复杂性，从而让全文搜索变得简单。</p>
<p>不过，Elasticsearch不仅仅是Lucene和全文搜索，我们还能这样去描述它：<br>•    分布式的实时文件存储，每个字段都被索引并可被搜索<br>•    分布式的实时分析搜索引擎<br>•    可以扩展到上百台服务器，处理PB级结构化或非结构化数据</p>
<p>总之，ES是一个牛逼的搜索存储引擎</p>
<h2 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h2><p>Mac上安装Docker很简单，基本跟着<a href="https://docs.docker.com/docker-for-mac/" title="https://docs.docker.com/docker-for-mac/" target="_blank" rel="external">官网</a>的引导就可以顺利安装了，完成后确保Docker已启动，如下图<br><img src="http://d.pr/i/13gIp+" alt=""></p>
<h2 id="创建Docker-镜像"><a href="#创建Docker-镜像" class="headerlink" title="创建Docker 镜像"></a>创建Docker 镜像</h2><p>Elasticsearch官方在Docker Hub上已经有提供镜像，如果没有额外需求，执行下面这个命令就可以直接使用Elasticsearch官方提供的镜像：</p>
<pre><code>docker run -d -p 9200:9200 --name=&quot;es&quot; elasticsearch:2.3.5
</code></pre><p>但我还想额外装一个Elasticsearch的插件，方便调适，所以就自己做了一个镜像，<a href=""> Dockerfile </a></p>
<pre><code>FROM elasticsearch:2.3.5

RUN /usr/share/elasticsearch/bin/plugin install mobz/elasticsearch-head

EXPOSE 9200
</code></pre><p>进入Dockerfile所在的文件夹，执行以下命令：</p>
<pre><code>docker build --tag=es_ezio:2.3.5 .
</code></pre><p>然后执行</p>
<pre><code>docker ps
</code></pre><p>就能看到刚才创建的镜像了<br><img src="http://d.pr/i/1k6a8+" alt=""></p>
<h2 id="启动容器及服务"><a href="#启动容器及服务" class="headerlink" title="启动容器及服务"></a>启动容器及服务</h2><p>上一步我们只是制作了一个Docker镜像，还没有创建Docker容器。关于Docker中镜像和容器的关系，可以类比为操作系统中的程序和进程，或者面向对象语言中的Class和Instance。我们必须从镜像创建出容器才能运行我们的服务（也就是Elasticsearch服务）。</p>
<p>第一次创建Docker容器，执行以下命令：</p>
<pre><code>docker run -d -p 9200:9200 --name=&quot;es_ezio&quot; es_ezio:2.3.5
</code></pre><p>Elasticsearch的默认端口是9200，我们把宿主环境9200映射到Docker容器中的9200端口，这样我们就可以直接访问宿主环境的9200端口就可以访问到Docker容器中的Elasticsearch服务了，同时我们把这个容器命名为es_ezio。</p>
<p>如果一切顺利，访问 <a href="http://127.0.0.1:9200/_plugin/head/" target="_blank" rel="external">http://127.0.0.1:9200/_plugin/head/</a><br><img src="http://d.pr/i/n8i8+" alt=""></p>
<p>这样，我们就完成了yo</p>
<h2 id="MAC-OS"><a href="#MAC-OS" class="headerlink" title="MAC OS"></a>MAC OS</h2>
          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/30/关于几个初始化shell文件/" itemprop="url">
                  关于几个初始化shell文件
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-08-30T20:00:00+08:00" content="2016-08-30">
              2016-08-30
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/30/关于几个初始化shell文件/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/30/关于几个初始化shell文件/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>shell在类linux系统中扮演的角色非常重要，连操作系统启动的入口一般都是shell，一般类linux系统启动时会涉及到这几个shell脚本，今天就来看看这几个脚本的作用</p>
<h2 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h2><p>/etc/profile:此文件为系统的每个用户设置环境信息,当用户第一次登录时,该文件被执行. 并从/etc/profile.d目录的配置文件中搜集shell的设置. </p>
<p>/etc/bashrc:为每一个运行bash shell的用户执行此文件.当bash shell被打开时,该文件被读取. </p>
<p>~/.bash_profile:每个用户都可使用该文件输入专用于自己使用的shell信息,当用户登录时,该 文件仅仅执行一次!默认情况下,他设置一些环境变量,执行用户的.bashrc文件. </p>
<p>~/.bashrc:该文件包含专用于你的bash shell的bash信息,当登录时以及每次打开新的shell时,该 该文件被读取. </p>
<p>另外,/etc/profile中设定的变量(全局)的可以作用于任何用户,而~/.bashrc等中设定的变量(局部)只能继承/etc/profile中的变量,他们是”父子”关系. </p>
<p>~/.bash_profile 是交互式、login 方式进入 bash 运行的<br>~/.bashrc 是交互式 non-login 方式进入 bash 运行的<br>通常二者设置大致相同，所以通常前者会调用后者。 </p>
<h2 id="MAC-OS"><a href="#MAC-OS" class="headerlink" title="MAC OS"></a>MAC OS</h2><p>MAC OS上的shell执行顺序有点特殊：<br>/etc/profile ->~/.bashrc(or .zshrc) -> /etc/bashrc</p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/17/Django源码分析之执行入口/" itemprop="url">
                  Django源码分析之执行入口
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-08-17T18:01:34+08:00" content="2016-08-17">
              2016-08-17
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/17/Django源码分析之执行入口/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/17/Django源码分析之执行入口/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="魔法门"><a href="#魔法门" class="headerlink" title="魔法门"></a>魔法门</h3><p>一般我们启动django，最简单的方法是进入project 目录，这时目录结构是这样的</p>
<p><img src="/images/django_project.png" alt=""></p>
<p>然后我们执行python manage.py runserver，程序就开始执行了。</p>
<p>那django是如何从一个命令就启动整个server，启动的流程是如何的？</p>
<h3 id="踏门而入"><a href="#踏门而入" class="headerlink" title="踏门而入"></a>踏门而入</h3><p>打开目录下的manage.py，内容是这样的：</p>
<pre><code>#!/usr/bin/env python
import os
import sys

if __name__ == &quot;__main__&quot;:
    os.environ.setdefault(&quot;DJANGO_SETTINGS_MODULE&quot;, &quot;django_learning.settings&quot;)

    from django.core.management import execute_from_command_line

    execute_from_command_line(sys.argv)
</code></pre><p>看来manage.py只是把命令行参数传给django.core.management模块中的execute_from_command_line 函数。</p>
<p>查看execute_from_command_line函数，可以发现实际执行的是ManagementUtility类的excute方法：</p>
<pre><code>def execute(self):
        &quot;&quot;&quot;
        Given the command-line arguments, this figures out which subcommand is
        being run, creates a parser appropriate to that command, and runs it.
        &quot;&quot;&quot;
        try:
            subcommand = self.argv[1]
        except IndexError:
            subcommand = &apos;help&apos;  # Display help if no arguments were given.

        # Preprocess options to extract --settings and --pythonpath.
        # These options could affect the commands that are available, so they
        # must be processed early.
        parser = CommandParser(None, usage=&quot;%(prog)s subcommand [options] [args]&quot;, add_help=False)
        parser.add_argument(&apos;--settings&apos;)
        parser.add_argument(&apos;--pythonpath&apos;)
        parser.add_argument(&apos;args&apos;, nargs=&apos;*&apos;)  # catch-all
        try:
            options, args = parser.parse_known_args(self.argv[2:])
            handle_default_options(options)
        except CommandError:
            pass  # Ignore any option errors at this point.

        no_settings_commands = [
            &apos;help&apos;, &apos;version&apos;, &apos;--help&apos;, &apos;--version&apos;, &apos;-h&apos;,
            &apos;compilemessages&apos;, &apos;makemessages&apos;,
            &apos;startapp&apos;, &apos;startproject&apos;,
        ]

        try:
            settings.INSTALLED_APPS
        except ImproperlyConfigured as exc:
            self.settings_exception = exc
            # A handful of built-in management commands work without settings.
            # Load the default settings -- where INSTALLED_APPS is empty.
            if subcommand in no_settings_commands:
                settings.configure()

        if settings.configured:
            # Start the auto-reloading dev server even if the code is broken.
            # The hardcoded condition is a code smell but we can&apos;t rely on a
            # flag on the command class because we haven&apos;t located it yet.
            if subcommand == &apos;runserver&apos; and &apos;--noreload&apos; not in self.argv:
                try:
                    autoreload.check_errors(django.setup)()
                except Exception:
                    # The exception will be raised later in the child process
                    # started by the autoreloader. Pretend it didn&apos;t happen by
                    # loading an empty list of applications.
                    apps.all_models = defaultdict(OrderedDict)
                    apps.app_configs = OrderedDict()
                    apps.apps_ready = apps.models_ready = apps.ready = True

            # In all other cases, django.setup() is required to succeed.
            else:
                django.setup()

        self.autocomplete()

        if subcommand == &apos;help&apos;:
            if &apos;--commands&apos; in args:
                sys.stdout.write(self.main_help_text(commands_only=True) + &apos;\n&apos;)
            elif len(options.args) &lt; 1:
                sys.stdout.write(self.main_help_text() + &apos;\n&apos;)
            else:
                self.fetch_command(options.args[0]).print_help(self.prog_name, options.args[0])
        # Special-cases: We want &apos;django-admin --version&apos; and
        # &apos;django-admin --help&apos; to work, for backwards compatibility.
        elif subcommand == &apos;version&apos; or self.argv[1:] == [&apos;--version&apos;]:
            sys.stdout.write(django.get_version() + &apos;\n&apos;)
        elif self.argv[1:] in ([&apos;--help&apos;], [&apos;-h&apos;]):
            sys.stdout.write(self.main_help_text() + &apos;\n&apos;)
        else:
            self.fetch_command(subcommand).run_from_argv(self.argv)
</code></pre><p>其中</p>
<pre><code>parser = CommandParser(None, usage=&quot;%(prog)s subcommand [options] [args]&quot;, add_help=False)
        parser.add_argument(&apos;--settings&apos;)
        parser.add_argument(&apos;--pythonpath&apos;)
        parser.add_argument(&apos;args&apos;, nargs=&apos;*&apos;)  # catch-all
        try:
            options, args = parser.parse_known_args(self.argv[2:])
            handle_default_options(options)
        except CommandError:
            pass  # Ignore any option errors at this point.
</code></pre><p>CommandParser其实类似于Argparse的一个解析命令行参数的类，从代码里可以看出我们可以直接在命令行指定settings文件和pythonpath。</p>
<pre><code>no_settings_commands = [
            &apos;help&apos;, &apos;version&apos;, &apos;--help&apos;, &apos;--version&apos;, &apos;-h&apos;,
            &apos;compilemessages&apos;, &apos;makemessages&apos;,
            &apos;startapp&apos;, &apos;startproject&apos;,
        ]
try:
            settings.INSTALLED_APPS
except ImproperlyConfigured as exc:
            self.settings_exception = exc
            # A handful of built-in management commands work without settings.
            # Load the default settings -- where INSTALLED_APPS is empty.
            if subcommand in no_settings_commands:
                settings.configure()
</code></pre><p>这块代码就可以解释我们执行python manage.py start project 时django在背后会调用settings.configure方法，这里的settings是指django.conf.LazySettings的一个实例，configure方法其实就是使用django.conf.global_settings.py中的默认设置创建一份新的配置文件，作为我们新创建的project的settings.py</p>
<pre><code>if settings.configured:
            # Start the auto-reloading dev server even if the code is broken.
            # The hardcoded condition is a code smell but we can&apos;t rely on a
            # flag on the command class because we haven&apos;t located it yet.
            if subcommand == &apos;runserver&apos; and &apos;--noreload&apos; not in self.argv:
                try:
                    autoreload.check_errors(django.setup)()
                except Exception:
                    # The exception will be raised later in the child process
                    # started by the autoreloader. Pretend it didn&apos;t happen by
                    # loading an empty list of applications.
                    apps.all_models = defaultdict(OrderedDict)
                    apps.app_configs = OrderedDict()
                    apps.apps_ready = apps.models_ready = apps.ready = True

            # In all other cases, django.setup() is required to succeed.
            else:
                django.setup()
</code></pre><p>autoreload.check_errors(django.setup)()其实也是调用django.setup方法，而django.setup方法</p>
<pre><code>def setup():
    &quot;&quot;&quot;
    Configure the settings (this happens as a side effect of accessing the
    first setting), configure logging and populate the app registry.
    &quot;&quot;&quot;
    from django.apps import apps
    from django.conf import settings
    from django.utils.log import configure_logging

    configure_logging(settings.LOGGING_CONFIG, settings.LOGGING)
    apps.populate(settings.INSTALLED_APPS)
</code></pre><p>负责初始化日志模块以及所有应用.</p>
<h3 id="抽丝剥茧"><a href="#抽丝剥茧" class="headerlink" title="抽丝剥茧"></a>抽丝剥茧</h3><p>剩下的代码最重要的就是这一句：</p>
<pre><code>self.fetch_command(subcommand).run_from_argv(self.argv)
</code></pre><p>fetch_command会根据subcommand（这是我们执行python manage.py rumserver时传入的第二个参数：runserver），去django.core.management.commands中查找对应的command类，然后把所有命令行参数传给run_from_argv方法并执行，在runserver这个示例中，最终会调用django.utils.autoreload中的python_reloader或者jython_reloader新开一个线程：</p>
<pre><code>def python_reloader(main_func, args, kwargs):
    if os.environ.get(&quot;RUN_MAIN&quot;) == &quot;true&quot;:
        thread.start_new_thread(main_func, args, kwargs)
        try:
            reloader_thread()
        except KeyboardInterrupt:
            pass
    else:
        try:
            exit_code = restart_with_reloader()
            if exit_code &lt; 0:
                os.kill(os.getpid(), -exit_code)
            else:
                sys.exit(exit_code)
        except KeyboardInterrupt:
            pass
</code></pre><p>这里的main_func是commands/runserver.py中的inner_run方法：</p>
<pre><code>def inner_run(self, *args, **options):
        # If an exception was silenced in ManagementUtility.execute in order
        # to be raised in the child process, raise it now.
        autoreload.raise_last_exception()

        threading = options.get(&apos;use_threading&apos;)
        shutdown_message = options.get(&apos;shutdown_message&apos;, &apos;&apos;)
        quit_command = &apos;CTRL-BREAK&apos; if sys.platform == &apos;win32&apos; else &apos;CONTROL-C&apos;

        self.stdout.write(&quot;Performing system checks...\n\n&quot;)
        self.check(display_num_errors=True)
        self.check_migrations()
        now = datetime.now().strftime(&apos;%B %d, %Y - %X&apos;)
        if six.PY2:
            now = now.decode(get_system_encoding())
        self.stdout.write(now)
        self.stdout.write((
            &quot;Django version %(version)s, using settings %(settings)r\n&quot;
            &quot;Starting development server at http://%(addr)s:%(port)s/\n&quot;
            &quot;Quit the server with %(quit_command)s.\n&quot;
        ) % {
            &quot;version&quot;: self.get_version(),
            &quot;settings&quot;: settings.SETTINGS_MODULE,
            &quot;addr&quot;: &apos;[%s]&apos; % self.addr if self._raw_ipv6 else self.addr,
            &quot;port&quot;: self.port,
            &quot;quit_command&quot;: quit_command,
        })

        try:
            handler = self.get_handler(*args, **options)
            run(self.addr, int(self.port), handler,
                ipv6=self.use_ipv6, threading=threading)
        except socket.error as e:
            # Use helpful error messages instead of ugly tracebacks.
            ERRORS = {
                errno.EACCES: &quot;You don&apos;t have permission to access that port.&quot;,
                errno.EADDRINUSE: &quot;That port is already in use.&quot;,
                errno.EADDRNOTAVAIL: &quot;That IP address can&apos;t be assigned to.&quot;,
            }
            try:
                error_text = ERRORS[e.errno]
            except KeyError:
                error_text = force_text(e)
            self.stderr.write(&quot;Error: %s&quot; % error_text)
            # Need to use an OS exit because sys.exit doesn&apos;t work in a thread
            os._exit(1)
        except KeyboardInterrupt:
            if shutdown_message:
                self.stdout.write(shutdown_message)
            sys.exit(0)
</code></pre><p>最关键的是这两条语句：</p>
<pre><code>handler = self.get_handler(*args, **options)
run(self.addr, int(self.port), handler,ipv6=self.use_ipv6, threading=threading)
</code></pre><p>get_handler会返回django.core.servers.basehttp中定义的一个application（其实就是我们project下的wigs.py中定义的application）</p>
<p>这是run函数的内容</p>
<pre><code>def run(addr, port, wsgi_handler, ipv6=False, threading=False):
    server_address = (addr, port)
    if threading:
        httpd_cls = type(str(&apos;WSGIServer&apos;), (socketserver.ThreadingMixIn, WSGIServer), {})
    else:
        httpd_cls = WSGIServer
    httpd = httpd_cls(server_address, WSGIRequestHandler, ipv6=ipv6)
    if threading:
        # ThreadingMixIn.daemon_threads indicates how threads will behave on an
        # abrupt shutdown; like quitting the server by the user or restarting
        # by the auto-reloader. True means the server will not wait for thread
        # termination before it quits. This will make auto-reloader faster
        # and will prevent the need to kill the server manually if a thread
        # isn&apos;t terminating correctly.
        httpd.daemon_threads = True
    httpd.set_app(wsgi_handler)
    httpd.serve_forever()
</code></pre><p>可以看出run函数其实就是启动一个WSGIServer实例（WSGIServer继承python内置类simple_server.WSGIServer），并把handler设置为前面get_handler的返回值</p>
<h3 id="水落石出"><a href="#水落石出" class="headerlink" title="水落石出"></a>水落石出</h3><p>这样，一条python manage.py runserver命令的执行生命周期就一览无余了。<br>接下来，server就开始接收请求了。</p>
<p>_</p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/17/Django源码分析之server/" itemprop="url">
                  Django源码分析之server
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-08-17T18:01:34+08:00" content="2016-08-17">
              2016-08-17
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/17/Django源码分析之server/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/17/Django源码分析之server/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="乍见"><a href="#乍见" class="headerlink" title="乍见"></a>乍见</h3><p>Django内置的server基本包括两部分：django.core.servers和django.core.handlers<br><img src="/images/django_server.png" alt=""></p>
<h3 id="相识"><a href="#相识" class="headerlink" title="相识"></a>相识</h3><p>servers.basehttp是Django自身提供的一个用于开发测试的server模块，其中提供的WSGIServer、ServerHandler、WSGIRequestHandler其实都是属于WSGI server，django只不过是对python内置的WSGI模块simple_server做的一层包装。</p>
<p>handlers package包括base.py和wsgi.py两个模块。<br>base.py中只定义了一个BaseHandler类，它复杂一些基础的功能，比如加载中间件，处理异常，获取响应数据等</p>
<p>wsgi.py才是主角，其中最重要的就是WSGIHandler类，它继承了base.py中的BaseHandler，只添加了一个__call__方法，那为什么添加这个方法呢？</p>
<p>django.core.wsgi</p>
<pre><code>import django
from django.core.handlers.wsgi import WSGIHandler


def get_wsgi_application():
    &quot;&quot;&quot;
    The public interface to Django&apos;s WSGI support. Should return a WSGI
    callable.

    Allows us to avoid making django.core.handlers.WSGIHandler public API, in
    case the internal WSGI implementation changes or moves in the future.
    &quot;&quot;&quot;
    django.setup()
    return WSGIHandler()
</code></pre><p>可见我们启动server时传入的application其实是WSGIHandler的一个实例，而根据WSGI规范，这个application必须要是callable，python中的callable包括函数、方法以及任何定义了__call__方法的对象</p>
<p>回到handlers.wsgi</p>
<pre><code>class WSGIHandler(base.BaseHandler):
    initLock = Lock()
    request_class = WSGIRequest

    def __call__(self, environ, start_response):
        # Set up middleware if needed. We couldn&apos;t do this earlier, because
        # settings weren&apos;t available.
        if self._request_middleware is None:
            with self.initLock:
                try:
                    # Check that middleware is still uninitialized.
                    if self._request_middleware is None:
                        self.load_middleware()
                except:
                    # Unload whatever middleware we got
                    self._request_middleware = None
                    raise

        set_script_prefix(get_script_name(environ))
        signals.request_started.send(sender=self.__class__, environ=environ)
        try:
            request = self.request_class(environ)
        except UnicodeDecodeError:
            logger.warning(&apos;Bad Request (UnicodeDecodeError)&apos;,
                exc_info=sys.exc_info(),
                extra={
                    &apos;status_code&apos;: 400,
                }
            )
            response = http.HttpResponseBadRequest()
        else:
            response = self.get_response(request)

        response._handler_class = self.__class__

        status = &apos;%s %s&apos; % (response.status_code, response.reason_phrase)
        response_headers = [(str(k), str(v)) for k, v in response.items()]
        for c in response.cookies.values():
            response_headers.append((str(&apos;Set-Cookie&apos;), str(c.output(header=&apos;&apos;))))
        start_response(force_str(status), response_headers)
        if getattr(response, &apos;file_to_stream&apos;, None) is not None and environ.get(&apos;wsgi.file_wrapper&apos;):
            response = environ[&apos;wsgi.file_wrapper&apos;](response.file_to_stream)
        return response
</code></pre><p>由于__call__是一个请求的入口，它需要调用BaseHandler中定义的方法去执行加载中间件等一系列操作和异常处理，除此之外，WSGIHandler还会处理cookie、触发signal等。</p>
<p>至于如何返回响应，具体可看handlers.base模块，大概就是找出请求的path，通过匹配路由，找到并执行用户定义的view方法，执行中间件处理方法，最后返回响应。当然，还有一系列的异常处理。</p>
<h3 id="回想"><a href="#回想" class="headerlink" title="回想"></a>回想</h3><p>这部分的内容需要对WSGi协议有个大致的了解，可以参考：<a href="http://xiaorui.cc/2016/04/16/%E6%89%93%E9%80%A0mvc%E6%A1%86%E6%9E%B6%E4%B9%8Bwsgi%E5%8D%8F%E8%AE%AE%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9%E5%8F%8A%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0/" target="_blank" rel="external">http://xiaorui.cc/2016/04/16/%E6%89%93%E9%80%A0mvc%E6%A1%86%E6%9E%B6%E4%B9%8Bwsgi%E5%8D%8F%E8%AE%AE%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9%E5%8F%8A%E6%8E%A5%E5%8F%A3%E5%AE%9E%E7%8E%B0/</a></p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/17/Django源码分析之权限系统_ 擒贼先擒王/" itemprop="url">
                  Django源码分析之权限系统\_ 擒贼先擒王
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-08-17T18:01:34+08:00" content="2016-08-17">
              2016-08-17
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/17/Django源码分析之权限系统_ 擒贼先擒王/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/17/Django源码分析之权限系统_ 擒贼先擒王/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="乍见"><a href="#乍见" class="headerlink" title="乍见"></a>乍见</h3><p>Django内置的权限系统已经很完善了，加上django-guardian提供的功能，基本上能满足大部分的权限需求。暂且不说django-guardian，我们先来看下Django内置的权限系统：django.contrib.auth 包。<br><img src="/images/django_auth_init.png" alt=""></p>
<h3 id="相识"><a href="#相识" class="headerlink" title="相识"></a>相识</h3><p>一般权限系统分为全局权限和对象权限。Django只提供了一个对象权限的框架，具体实现由第三方库django-gardian完成。我们只看全局权限。</p>
<p>先来看auth包暴露出哪些接口。</p>
<p>django.contrib.auth.__init__.py</p>
<pre><code>def load_backend(path):
    return import_string(path)()


def _get_backends(return_tuples=False):
    backends = []
    for backend_path in settings.AUTHENTICATION_BACKENDS:
        backend = load_backend(backend_path)
        backends.append((backend, backend_path) if return_tuples else backend)
    if not backends:
        raise ImproperlyConfigured(
            &apos;No authentication backends have been defined. Does &apos;
            &apos;AUTHENTICATION_BACKENDS contain anything?&apos;
        )
    return backends


def get_backends():
    return _get_backends(return_tuples=False)
</code></pre><p>前三个方法都是为了加载backends。一个backend其实就是一个class，必须实现authenticate和get_user两个方法。每当我们这样验证用户时</p>
<pre><code>authenticate(username=&apos;username&apos;, password=&apos;password&apos;)
</code></pre><p>django就会去调用这些backend class，用其提供的方法去验证用户权限。那django是如何知道要调用哪些backend class呢？答案就在settings.py中，默认为</p>
<pre><code>AUTHENTICATION_BACKENDS = [&apos;django.contrib.auth.backends.ModelBackend&apos;]
</code></pre><p>那Django是如何调用这些backend class的呢？</p>
<pre><code>def authenticate(**credentials):
    &quot;&quot;&quot;
    If the given credentials are valid, return a User object.
    &quot;&quot;&quot;
    for backend, backend_path in _get_backends(return_tuples=True):
        try:
            inspect.getcallargs(backend.authenticate, **credentials)
        except TypeError:
            # This backend doesn&apos;t accept these credentials as arguments. Try the next one.
            continue

        try:
            user = backend.authenticate(**credentials)
        except PermissionDenied:
            # This backend says to stop in our tracks - this user should not be allowed in at all.
            return None
        if user is None:
            continue
        # Annotate the user object with the path of the backend.
        user.backend = backend_path
        return user

    # The credentials supplied are invalid to all backends, fire signal
    user_login_failed.send(sender=__name__,
            credentials=_clean_credentials(credentials))
</code></pre><p>由此可见，Django会在第一个验证正确的backend class调用完成后停止，或者碰到PermissionDenied异常也会停止，所以backend class的顺序也很重要。可以添加自定义的backend class。</p>
<pre><code>def login(request, user):
    &quot;&quot;&quot;
    Persist a user id and a backend in the request. This way a user doesn&apos;t
    have to reauthenticate on every request. Note that data set during
    the anonymous session is retained when the user logs in.
    &quot;&quot;&quot;
    session_auth_hash = &apos;&apos;
    if user is None:
        user = request.user
    if hasattr(user, &apos;get_session_auth_hash&apos;):
        session_auth_hash = user.get_session_auth_hash()

    if SESSION_KEY in request.session:
        if _get_user_session_key(request) != user.pk or (
                session_auth_hash and
                request.session.get(HASH_SESSION_KEY) != session_auth_hash):
            # To avoid reusing another user&apos;s session, create a new, empty
            # session if the existing session corresponds to a different
            # authenticated user.
            request.session.flush()
    else:
        request.session.cycle_key()
    request.session[SESSION_KEY] = user._meta.pk.value_to_string(user)
    request.session[BACKEND_SESSION_KEY] = user.backend
    request.session[HASH_SESSION_KEY] = session_auth_hash
    if hasattr(request, &apos;user&apos;):
        request.user = user
    rotate_token(request)
    user_logged_in.send(sender=user.__class__, request=request, user=user)
</code></pre><p>login方法，顾名思义，登录用户，同时设置好session，最后发送登入成功通知</p>
<pre><code>def logout(request):
    &quot;&quot;&quot;
    Removes the authenticated user&apos;s ID from the request and flushes their
    session data.
    &quot;&quot;&quot;
    # Dispatch the signal before the user is logged out so the receivers have a
    # chance to find out *who* logged out.
    user = getattr(request, &apos;user&apos;, None)
    if hasattr(user, &apos;is_authenticated&apos;) and not user.is_authenticated():
        user = None
    user_logged_out.send(sender=user.__class__, request=request, user=user)

    # remember language choice saved to session
    language = request.session.get(LANGUAGE_SESSION_KEY)

    request.session.flush()

    if language is not None:
        request.session[LANGUAGE_SESSION_KEY] = language

    if hasattr(request, &apos;user&apos;):
        from django.contrib.auth.models import AnonymousUser
        request.user = AnonymousUser()
</code></pre><p>相对的，logout方法，负责登出用户，清理session，最后设置当前用户为匿名用户</p>
<pre><code>def get_user_model():
    &quot;&quot;&quot;
    Returns the User model that is active in this project.
    &quot;&quot;&quot;
    try:
        return django_apps.get_model(settings.AUTH_USER_MODEL)
    except ValueError:
        raise ImproperlyConfigured(&quot;AUTH_USER_MODEL must be of the form &apos;app_label.model_name&apos;&quot;)
    except LookupError:
        raise ImproperlyConfigured(
            &quot;AUTH_USER_MODEL refers to model &apos;%s&apos; that has not been installed&quot; % settings.AUTH_USER_MODEL
        )
</code></pre><p>Django不推荐直接使用User class，而是通知get_user_model方法获取当前的用户class（或者使用settins.AUTH_USER_MODEL）。这是为了防止因为开发者使用了自定义用户class而导致的信息错误。</p>
<pre><code>def update_session_auth_hash(request, user):
    &quot;&quot;&quot;
    Updating a user&apos;s password logs out all sessions for the user if
    django.contrib.auth.middleware.SessionAuthenticationMiddleware is enabled.

    This function takes the current request and the updated user object from
    which the new session hash will be derived and updates the session hash
    appropriately to prevent a password change from logging out the session
    from which the password was changed.
    &quot;&quot;&quot;
    if hasattr(user, &apos;get_session_auth_hash&apos;) and request.user == user:
        request.session[HASH_SESSION_KEY] = user.get_session_auth_hash()
</code></pre><p>最后这个方法的使用场景很少。一般我们更新用户密码时，会在session中清除用户登录信息，导致用户需要重新登录。而使用update_session_auth_hash我们就可以在更新用户密码的同时更新用户的session信息，这样，用户就不需要重新登录了。</p>
<h3 id="回想"><a href="#回想" class="headerlink" title="回想"></a>回想</h3><p>擒贼先擒王，以上都是django.contrib.auth包中的__init__.py入口文件中的内容，背后还有很多“能工巧匠”，否则怎么支撑起auth整套权限系统？后续文章会一一介绍。</p>
<p>_</p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/17/关于跨域的一些事/" itemprop="url">
                  关于跨域的一些事
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-08-17T18:01:34+08:00" content="2016-08-17">
              2016-08-17
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/17/关于跨域的一些事/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/17/关于跨域的一些事/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>web前端开发中，我们经常需要访问除了源服务器（输出当前页面的服务器）外的服务，这时由于浏览器同源策略<a href="https://en.wikipedia.org/wiki/Same-origin_policy" target="_blank" rel="external">https://en.wikipedia.org/wiki/Same-origin_policy</a>的限制，我们需要做很多额外的修改才能达到目的。而在web后端开发中，我们可以直接从一个服务器发送请求到另一个服务器，由于不存在浏览器做中介，所以可以很方便地进行通信，诞生了各种RPC框架，这些框架的底层通信模块常见的基本都是使用socket、HTTP、PB（Protocol Buffers）等通信协议。这篇文章只说在浏览器参与的跨域中的情况。</p>
<p>跨域分两种：跨子域和跨全域。从easydb.dtstack.com发送HTTPRequest到www.dtstack.com，这样的叫跨子域；从www.baidu.com发送HTTPRequest到www.dtstack.com，这样的叫跨全域。</p>
<p>关于跨域通信，目前已经有了很多方法，最常见的就是JSONP，但JSONP和<br>Ajax并不相同。Ajax<a href="https://zh.wikipedia.org/zh/AJAX" target="_blank" rel="external">https://zh.wikipedia.org/zh/AJAX</a>通常都是通过新建XMLHTTPRequest（IE下还有类似XMLDomainRequest）来创建请求，而JSONP的本质其实是利用向DOM中插入script标签来“触发”请求，因此JSONP不会受到浏览器同源策略的影响。因此，许多web service都是通过JSONP实现。但JSONP任何人都能调用，无形中放大了服务器的潜在bug危害，因此我们还会时不时地用到Ajax。接下来我们就来聊聊Django中常见的Ajax跨域解决方案。</p>
<h2 id="跨子域"><a href="#跨子域" class="headerlink" title="跨子域"></a>跨子域</h2><p>解决跨子域有纯前端的方案，比如从easydb.dtstack.com跨子域访问www.dtstack.com，只需要在JS中设置<br><code>document.domain = &#39;dtstack.com&#39;</code><br>然后正常发送请求就行了。</p>
<p>也有前后端配合的方案，可以参考跨全域的方案。</p>
<h2 id="跨全域"><a href="#跨全域" class="headerlink" title="跨全域"></a>跨全域</h2><p>跨全域通信的关键在于被访问的服务器允许访问方进行访问。</p>
<p>因此，一般发送跨域请求时，浏览器会“询问”服务器是否允许当前请求进行访问，“询问”的方式是通过发送一个OPTIONS请求，这时被访问服务器需要返回一些信息表示是否允许，这些信息一般放在HTTP header中。这样，如果被访问服务器返回表示允许访问的HTTP header，那么浏览器就会发送用户创建的跨域请求，这样就完成了跨域通信了。</p>
<p>基本原理弄清楚了，接下来就是实现细节了。</p>
<p>Django中，我们可以添加一个中间件来为跨域请求设置恰当的HTTP header。首先创建一个cross_domain_middleware.py文件</p>
<pre><code>from dtuic.settings import ALLOWED_HOSTS_FOR_MIDDLEWARE

class CrossDomainMiddleware(object):

    def process_response(self, request, response):

        origin = request.META.get(&apos;HTTP_ORIGIN&apos;)
        allowed_hosts = self.get_allowed_hosts(request)

        if origin in allowed_hosts or &apos;*&apos; in allowed_hosts:
            response[&quot;Access-Control-Allow-Headers&quot;] = &quot;Origin, X-Requested-With, Content-Type, Accept, Key, source&quot;
            response[&quot;Access-Control-Allow-Methods&quot;] = &quot;POST, GET, OPTIONS, DELETE, PUT&quot;
            response[&quot;Access-Control-Allow-Origin&quot;] = origin
            response[&quot;Access-Control-Max-Age&quot;] = &quot;1000&quot;
            response[&apos;Access-Control-Allow-Credentials&apos;] = &quot;true&quot;

        return response

    def get_allowed_hosts(self, request):
        hosts = []
        for host in ALLOWED_HOSTS_FOR_MIDDLEWARE.split(&apos;,&apos;):
            host = host.strip()
            if host != &apos;*&apos;:
                host = &quot;{}://{}&quot;.format(request.scheme, host)

            hosts.append(host)

        return hosts
</code></pre><p>，同时在settings文件中添加</p>
<pre><code>ALLOWED\_HOSTS\_FOR\_MIDDLEWARE = &quot;www.baidu.com, www.whatever.com&quot;
</code></pre><p>，最后在Django的middleware配置中添加我们新建的cross_domain_middleware</p>
<pre><code>MIDDLEWARECLASSES = (
&apos;dtuic.middleware.crossdomainmiddleware.CrossDomainMiddleware&apos;,
&apos;django.contrib.sessions.middleware.SessionMiddleware&apos;,
...
)
</code></pre><p>放在最前面，见<a href="">https://docs.djangoproject.com/en/1.10/ref/settings/#allowed-hosts</a></p>
<p>目前ALLOWED_HOSTS_FOR_MIDDLEWARE 只支持多个域名显示配置，也可以使用正则动态匹配。</p>
<p>注意Django中的ALLOWED_HOSTS并不是为了跨域的配置，而是针对全局请求访问的一个配置，如果直接覆盖，可能会导致全站400，本地开发时由于Django的调适标识Debug都为True，Django这时是默认允许所有请求访问的，所以即使覆盖了ALLOWED_HOSTS也不会有问题，而到了线上，Debug切换到False，就会有“惊喜”了。</p>
<p>参考：<br><a href="">http://www.html5rocks.com/en/tutorials/cors/</a></p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/17/定时爬虫抓当日免费应用/" itemprop="url">
                  定时爬虫抓当日免费应用：Scrapy + Tkinter + LaunchControl
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-08-17T18:01:34+08:00" content="2016-08-17">
              2016-08-17
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/17/定时爬虫抓当日免费应用/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/17/定时爬虫抓当日免费应用/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>花了个周末学了下Scrapy，正好一直想买<a href="https://mindnode.com/" target="_blank" rel="external">mindnode</a>，于是顺手做了个爬虫，抓取<a href="http://www.ifanr.com/app" target="_blank" rel="external">爱范儿</a>每天的限免应用信息。</p>
<h2 id="Thinking"><a href="#Thinking" class="headerlink" title="Thinking"></a>Thinking</h2><p>大概思路就是使用LaunchControl每天定时（比如早上9点50，这时正好刚到公司不久）跑一下爬虫脚本，如果找到感兴趣的应用在限免，就使用Tkinter弹出提示。当然，也可以直接用Scrapy做定时任务，以后再说。</p>
<h2 id="Coding"><a href="#Coding" class="headerlink" title="Coding"></a>Coding</h2><h3 id="Scrapy-＋-Tkinter"><a href="#Scrapy-＋-Tkinter" class="headerlink" title="Scrapy ＋ Tkinter"></a>Scrapy ＋ Tkinter</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line">import scrapy</span><br><span class="line">import Tkinter</span><br><span class="line">from scrapy.shell import inspect_response</span><br><span class="line">import json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置感兴趣的app名称</span></span><br><span class="line">I_want_apps = <span class="built_in">set</span>([<span class="string">'mindnode pro'</span>, <span class="string">'u.memory'</span>])</span><br><span class="line"></span><br><span class="line">class XianmianSpider(scrapy.Spider):</span><br><span class="line">    user_agent = <span class="string">'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2623.112 Safari/537.36'</span></span><br><span class="line">    name = <span class="string">"xianmian"</span></span><br><span class="line">    allowed_domains = [<span class="string">"app.so"</span>]</span><br><span class="line">    start_urls = (</span><br><span class="line">        <span class="string">'http://app.so/api/v1.1/appso/discount/?platform=web&amp;limit=10'</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    def parse(self, response):</span><br><span class="line"></span><br><span class="line">        jsonresponse = json.loads(response.body_as_unicode())</span><br><span class="line"></span><br><span class="line">        apps = jsonresponse[<span class="string">'objects'</span>]</span><br><span class="line"></span><br><span class="line">        appTitles = &#123;item[<span class="string">'display_name'</span>].lower() <span class="keyword">for</span> item <span class="keyword">in</span> apps&#125;</span><br><span class="line"></span><br><span class="line">        self.logger.info(<span class="string">'today\'</span> apps are: <span class="string">' + str(appTitles))</span><br><span class="line"></span><br><span class="line">        the_apps = appTitles &amp; I_want_apps</span><br><span class="line">        if the_apps:</span><br><span class="line">        	self.showMsg('</span>found the apps: &#123;&#125;<span class="string">'.format(list(the_apps)))</span><br><span class="line"></span><br><span class="line">    def showMsg(self, msg):</span><br><span class="line">    	import Tkinter</span><br><span class="line">    	root = Tkinter.Tk()</span><br><span class="line">    	root.title('</span>福利到！<span class="string">')</span><br><span class="line">    	label = Tkinter.Label(root, text=msg)</span><br><span class="line">    	label.pack()</span><br><span class="line">    	center_window(root, 300, 240)</span><br><span class="line">    	root.maxsize(600, 400)</span><br><span class="line">    	root.minsize(300, 240)</span><br><span class="line">    	Tkinter.mainloop()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def get_screen_size(window):  </span><br><span class="line">    return window.winfo_screenwidth(),window.winfo_screenheight()  </span><br><span class="line">  </span><br><span class="line">def get_window_size(window):  </span><br><span class="line">    return window.winfo_reqwidth(),window.winfo_reqheight()  </span><br><span class="line">  </span><br><span class="line">def center_window(root, width, height):  </span><br><span class="line">    screenwidth = root.winfo_screenwidth()  </span><br><span class="line">    screenheight = root.winfo_screenheight()  </span><br><span class="line">    size = '</span>%dx%d+%d+%d<span class="string">' % (width, height, (screenwidth - width)/2, (screenheight - height)/2)  </span><br><span class="line">    print(size)  </span><br><span class="line">    root.geometry(size)</span></span><br></pre></td></tr></table></figure>
<h3 id="LaunchControl"><a href="#LaunchControl" class="headerlink" title="LaunchControl"></a>LaunchControl</h3><p> <img src="/images/launchcontrol_shot.png" alt="title"></p>
<p> LaunchControl用起来比较直观，当然，也可以直接用mac自带的launchctl，具体可参考<a href="http://ylq365.iteye.com/blog/1878917" target="_blank" rel="external">launchctl使用说明</a></p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/17/排查实时tail功能cpu占用过高问题/" itemprop="url">
                  排查实时tail功能cpu占用过高问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-08-17T18:01:34+08:00" content="2016-08-17">
              2016-08-17
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/17/排查实时tail功能cpu占用过高问题/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/17/排查实时tail功能cpu占用过高问题/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="白日惊雷"><a href="#白日惊雷" class="headerlink" title="白日惊雷"></a>白日惊雷</h3><p>“你的python应用cpu占用快90%了！！！”，良哥朝我眨了眨布满血丝的眼睛<br>“不会吧”，我心想：我这是好的啊</p>
<blockquote>
<p>没接触过kafka的同学可以先了解下：(<a href="">http://www.jasongj.com/2015/03/10/KafkaColumn1/</a>)</p>
</blockquote>
<h3 id="疑云重重"><a href="#疑云重重" class="headerlink" title="疑云重重"></a>疑云重重</h3><p>SSH到远程机器上，运行top命令看一下，果然平常4%不到的cpu占用，现在飙升到90%左右了。</p>
<p>这是一个简单的应用：server端从kafka读消息，通过websocket发送到client端，整个server端代码也就几百行。</p>
<p> <img src="/images/livetail_architecture.png" alt=""></p>
<p>那就直接看代码吧。</p>
<p>由于线上环境的kafka没有开放端口，我是在本地搭的kafka环境，所以为了快速开发，就在server端直接写了一个kafka生产者，向kafka提交消息。因此，</p>
<p>猜想1: 难道是不小心把kafka生产者的代码也提交上去了？<br>check最新代码，生产者的代码明显被注释掉了，并没生效。</p>
<p>猜想2:websocket与server端链接太多了？<br>不可能，这个功能目前还没开始公测，而且只有这一个server cpu占比过高。</p>
<p>那还是server和kafka之间出现了问题。</p>
<h3 id="初现端倪"><a href="#初现端倪" class="headerlink" title="初现端倪"></a>初现端倪</h3><p>server端会在每个请求到来时创建一个websocket连接，同时创建一个kafka消费者线程，用来监听特定topic的消息。</p>
<p>client端与server端的websocket会在用户刷新页面或者关闭页面时断开连接，这个不会有问题。那问题有可能出在：创建的kafka消费者线程没有正确地退出。</p>
<p>每个python线程会有一个daemon属性，默认为False。python主线程会在所有daemon为False的线程退出后才终止，而daemon为True的线程（也就是后台线程）会在主线程退出时一起退出。</p>
<p>所以无论如何，每次发布时都是重启整个进程，不会有资源回收失败的问题。</p>
<p>那就是在server运行时创建了过多的kafka消费者线程。</p>
<p>验证一下，打开pycharm的并发状态检测开关并启动server，新开一个页面，连续刷新几次，pycharm里就可以看到刚才创建的线程活的好好的！！！</p>
<p> <img src="/images/concurrent_thread.png" alt=""></p>
<p> <img src="http://img4.imgtn.bdimg.com/it/u=157241173,3207275343&amp;fm=21&amp;gp=0.jpg" alt=""></p>
<h3 id="水落石出"><a href="#水落石出" class="headerlink" title="水落石出"></a>水落石出</h3><p>那来看看kafka消费者线程在干什么。</p>
<p>kafka消费者线程负责：</p>
<p>连接kafka<br>获取消息<br>向websocket连接写入消息</p>
<p>祭出debug神器：<strong>断点</strong></p>
<p>根据多年打断点的经验，果断滴选择了“获取消息”。</p>
<p>经过一段时间的调试，原来是kafka-python从kafka获取消息时会进入无限while循环，从而阻塞线程。</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>既然弄明白了问题的来龙去脉，解决起来就容易了。</p>
<p>首先看kaka-python有没有异步api，在官方文档里找了一圈，并没有，最后发现</p>
<p>  <img src="/images/kafka_python_config.png" alt=""></p>
<p>，利用异常我们可以跳出while循环，从而有机会结束当前线程。大致代码如下：</p>
<pre><code>class ConsumerThread(Threading.thread):
    ...

    def fetchMsg(self):
        for message in self.consumer:

            if self.stopThread:
                break

                message_value = message.value

                socket.pubsub(message_value)

            else:

                logger.error(&apos;consumer timeout&apos;)

                if not self.stopThread:
                    self.fetchMsg()
                else:
                    self.consumer.close()
</code></pre><h3 id="一些感想"><a href="#一些感想" class="headerlink" title="一些感想"></a>一些感想</h3><p>连接kafka的kafka-python竟然没做成事件驱动，反而是阻塞式，这不明显是挖坑让人跳么？</p>

          
        
      
    </div>
    
    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpeg"
               alt="Ezio" />
          <p class="site-author-name" itemprop="name">Ezio</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">8</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        <div class="links-of-blogroll motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ezio</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"githubliuyunclouder"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  
  

  

  

</body>
</html>
